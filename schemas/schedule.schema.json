{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/yourorg/remote-battery-control-system/schemas/schedule.schema.json",
  "title": "Battery Schedule Message",
  "description": "Schema for daily battery schedule messages published by cloud service to edge devices",
  "type": "object",
  "required": ["schedule_id", "device_id", "version", "intervals", "generated_at"],
  "properties": {
    "schedule_id": {
      "type": "string",
      "description": "Unique identifier for this schedule. Typically date-based (e.g., '2024-01-15') to enable idempotent retries. Cloud can safely republish the same schedule_id without devices applying it twice.",
      "pattern": "^[a-zA-Z0-9_-]+$",
      "examples": ["2025-12-25", "2025-12-25-device-001"]
    },
    "device_id": {
      "type": "string",
      "description": "Target device identifier. Used for topic routing (devices/{device_id}/schedule) and device-side validation. Enables per-device scheduling and debugging.",
      "pattern": "^[a-zA-Z0-9_-]+$",
      "examples": ["device-001", "device-12345"]
    },
    "max_power_kw": {
      "type": "number",
      "description": "Optional device-specific maximum power limit in kilowatts. If provided, devices validate that all interval rate_kw values are within Â±max_power_kw. Enables edge validation for different device models with varying capabilities.",
      "minimum": 0,
      "examples": [50, 30, 100]
    },
    "version": {
      "type": "integer",
      "description": "Schema version (e.g., 1, 2). Critical for protocol evolution: devices reject unknown versions to prevent applying incompatible schedules. Supports backward compatibility and gradual rollouts. Matches PDF specification.",
      "examples": [1, 2]
    },
    "intervals": {
      "type": "array",
      "description": "Array of half-hour time slots defining power setpoints throughout the day. Each interval represents 30 minutes of battery operation.",
      "minItems": 1,
      "maxItems": 48,
      "items": {
        "type": "object",
        "required": ["start", "end", "rate_kw"],
        "properties": {
          "start": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 timestamp for the start of this interval. Full timestamp format matching PDF specification (e.g., '2025-12-25T00:00:00Z').",
            "examples": ["2025-12-25T00:00:00Z", "2025-12-25T12:30:00Z"]
          },
          "end": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 timestamp for the end of this interval. Typically start + 30 minutes for half-hour intervals. Matches PDF specification.",
            "examples": ["2025-12-25T00:30:00Z", "2025-12-25T13:00:00Z"]
          },
          "rate_kw": {
            "type": "number",
            "description": "Power rate in kilowatts. Positive values indicate charging, negative values indicate discharging, zero indicates idle. Matches PDF field name 'rate_kw'. Range must match device specifications (e.g., MAX300 capabilities). Devices must reject schedules with rate_kw outside allowed range.",
            "minimum": -50,
            "maximum": 50,
            "examples": [100, -50, 10.5, 0.0]
          },
          "mode": {
            "type": "string",
            "enum": ["CHARGE", "DISCHARGE", "IDLE"],
            "description": "Optional explicit mode field for traceability in dashboards. If omitted, mode is derived from rate_kw sign (positive=CHARGE, negative=DISCHARGE, zero=IDLE). Provided for symmetry with original PDF design; rate_kw sign is the source of truth.",
            "examples": ["CHARGE", "DISCHARGE", "IDLE"]
          }
        }
      }
    },
    "generated_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when the cloud service generated this schedule. Matches PDF field name 'generated_at'. Used for observability, debugging, and detecting stale schedules. Devices can reject schedules that are too old.",
      "examples": ["2025-12-24T12:00:00Z", "2025-12-25T12:30:45+00:00"]
    }
  },
  "additionalProperties": false,
  "comments": {
    "design_decisions": [
      "schedule_id enables idempotency: cloud can safely retry publishes without devices re-applying schedules",
      "version field supports protocol evolution: devices can reject unknown versions to prevent errors",
      "intervals array is limited to 48 items (24 hours * 2 slots/hour) to bound message size",
      "start and end use full ISO 8601 timestamps matching PDF specification for clarity and precision",
      "rate_kw matches PDF field name (was power_kw in earlier version)",
      "rate_kw encodes mode via sign (positive=charge, negative=discharge, zero=idle) rather than explicit mode field for cleaner design",
      "optional mode field added for traceability in dashboards and symmetry with original PDF design; rate_kw sign remains source of truth",
      "rate_kw range (-50 to 50) is example; must match actual device specifications (e.g., MAX300 max power ratings)",
      "optional max_power_kw field enables device-specific edge validation for different device models",
      "devices must reject schedules with rate_kw values outside allowed range (edge validation requirement)",
      "generated_at matches PDF field name (was issued_at in earlier version)",
      "generated_at supports observability: cloud can track schedule generation time vs application time",
      "additionalProperties: false ensures strict schema validation and prevents accidental field additions"
    ]
  }
}

